<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgroCore - Owner Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #0f172a; --accent: #10b981; --bg: #f1f5f9; --text: #334155; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); display: flex; height: 100vh; margin:0; }
        .sidebar { width: 250px; background: var(--primary); color: white; padding: 20px; }
        .main { flex: 1; padding: 30px; overflow-y: auto; }
        .card { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .stat-box { background: white; padding: 20px; border-radius: 10px; display: flex; align-items: center; justify-content: space-between; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px; background: #eee; }
        td { padding: 15px; border-bottom: 1px solid #ddd; }
        .badge { background: #dcfce7; color: #166534; padding: 5px 10px; border-radius: 20px; font-weight: bold; font-size: 0.8em; }
        .loading { color: red; font-weight: bold; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2 style="margin-bottom: 40px;"><i class="fa-solid fa-building-wheat"></i> AgroCore</h2>
        <div style="padding:10px; background:rgba(255,255,255,0.1); border-radius:5px; margin-bottom:10px;"><i class="fa-solid fa-chart-pie"></i> Dashboard</div>
        <div style="padding:10px; opacity:0.7;"><i class="fa-solid fa-video"></i> CCTV</div>
    </div>

    <div class="main">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:30px;">
            <h2>Dashboard Real-Time (NTFY Cloud)</h2>
            <div id="connection-status" class="loading">Mencari Data...</div>
        </div>

        <div class="stat-grid">
            <div class="stat-box">
                <div><h4 style="color:gray; margin:0;">Laporan Masuk</h4><h1 style="margin:5px 0;" id="total-laporan">0</h1></div>
                <i class="fa-solid fa-users fa-2x" style="color:var(--primary);"></i>
            </div>
            <div class="stat-box">
                <div><h4 style="color:gray; margin:0;">Total Tagihan</h4><h1 style="margin:5px 0; color:#f59e0b;" id="total-gaji">Rp 0</h1></div>
                <i class="fa-solid fa-wallet fa-2x" style="color:#f59e0b;"></i>
            </div>
        </div>

        <div class="card">
            <h3><i class="fa-solid fa-list"></i> Data Masuk (Dari HP Buruh)</h3>
            <table>
                <thead><tr><th>Waktu</th><th>Nama</th><th>Sektor</th><th>Aktivitas</th><th>Gaji</th><th>Status</th></tr></thead>
                <tbody id="table-body"></tbody>
            </table>
            <div id="empty-msg" style="text-align:center; padding:20px; color:gray;">Menunggu data dari server...</div>
        </div>
    </div>

    <script>
        // HARUS SAMA DENGAN BURUH
        const TOPIC = "agrocore_project_galih_v2";
        // Mengambil data 1 jam terakhir
        const SERVER_URL = `https://ntfy.sh/${TOPIC}/json?poll=1&since=1h`; 

        function formatRupiah(num) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(num);
        }

        let processedIds = []; // Supaya tidak duplikat

        function fetchData() {
            fetch(SERVER_URL)
            .then(res => res.text()) // Ambil teks karena formatnya JSON stream
            .then(text => {
                // ntfy mengembalikan beberapa baris JSON, kita pecah per baris
                const lines = text.trim().split('\n');
                
                // Ambil elemen tabel
                const tbody = document.getElementById('table-body');
                const emptyMsg = document.getElementById('empty-msg');
                const status = document.getElementById('connection-status');
                
                status.innerText = "â— Terhubung (Live)";
                status.style.color = "green";
                status.classList.remove('loading');

                let totalCount = 0;
                let totalMoney = 0;
                
                // Bersihkan tabel dulu untuk render ulang yang rapi
                // (Dalam aplikasi asli bisa di-append, tapi ini biar simpel)
                tbody.innerHTML = ''; 

                // Loop dari bawah (terbaru) ke atas
                lines.forEach(line => {
                    if(!line) return;
                    try {
                        const msg = JSON.parse(line);
                        // Cek apakah ini event message (bukan open/keepalive)
                        if (msg.event === 'message') {
                            const data = JSON.parse(msg.message); // Parse isi pesan
                            
                            totalCount++;
                            totalMoney += data.wage;
                            emptyMsg.style.display = 'none';

                            const row = `
                                <tr>
                                    <td>${data.time}</td>
                                    <td><b>${data.name}</b></td>
                                    <td>${data.sector}</td>
                                    <td>${data.summary}</td>
                                    <td style="font-weight:bold;">${formatRupiah(data.wage)}</td>
                                    <td><span class="badge">Diterima</span></td>
                                </tr>
                            `;
                            // Masukkan ke paling atas
                            tbody.insertAdjacentHTML('afterbegin', row);
                        }
                    } catch (e) {
                        console.log("Data skip (bukan JSON valid):", line);
                    }
                });

                if(totalCount > 0) {
                    document.getElementById('total-laporan').innerText = totalCount;
                    document.getElementById('total-gaji').innerText = formatRupiah(totalMoney);
                }
            })
            .catch(err => {
                console.log("Waiting...", err);
            });
        }

        // Cek data setiap 3 detik
        setInterval(fetchData, 3000);
        fetchData();
    </script>
</body>
</html>
